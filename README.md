# cosmwasm_experiment

## Compiling the contract

The contract has been compiled by running `RUSTFLAGS='-C link-arg=-s' cargo build --release --target wasm32-unknown-unknown` from inside the `contract` directory.

```shell
rustc --version                                                                 
rustc 1.52.1 (9bc8c42bb 2021-05-09)
```

## Used validator

The validator used for tests been compiled as per instructions in <https://nymtech.net/docs/run-nym-nodes/validators/>. It was using version `v0.14.1` of wasmd.
The test has been attempted by compiling using both Go 1.15 and 1.16 so both `MADV_FREE` and `MADV_DONTNEED` were checked.

In another attempt [pprof](https://golang.org/pkg/net/http/pprof/) has been put into the binary. It did not detect any memory leaks indicating the problem most likely lies outside the Go's VM. As a matter of fact, pprof reported that the memory used was never above about 100 MB. Sample MemStats from debug output (**FROM DIFFERENT MACHINE THAT THE ONE THAT RUN THE BELOW TEST**), i.e. <http://localhost:6060/debug/pprof/heap?debug=1> after the process has been running for few hours and was close to getting OOM'd:

```
# runtime.MemStats
# Alloc = 247185096
# TotalAlloc = 545558782696
# Sys = 592312376
# Lookups = 0
# Mallocs = 3689952560
# Frees = 3689267146
# HeapAlloc = 247185096
# HeapSys = 533725184
# HeapIdle = 241999872
# HeapInuse = 291725312
# HeapReleased = 51339264
# HeapObjects = 685414
# Stack = 3145728 / 3145728
# MSpan = 1891352 / 2670592
# MCache = 13888 / 16384
# BuckHashSys = 27954791
# GCSys = 22811480
# OtherSys = 1988217
# NextGC = 489739952
# LastGC = 1621847486193431556
# PauseNs = [98601 84731 120921 103520 131460 84741 90420 113590 81390 101261 83910 86719 100911 93790 166970 79600 133539 252570 85150 149130 4107483 137621 92612 142461 81950 168980 92920 90500 76641 86360 80650 95351 194172 113711 90040 84760 82221 120580 140839 159071 132051 152591 95690 128021 79200 278650 80640 80439 126670 161991 206711 296179 106651 118181 102251 123011 79210 152280 76991 77210 83401 114299 115440 87219 76150 106161 81749 203620 82771 80201 79601 170080 80510 151770 114029 102920 94689 131830 107841 136320 149819 120781 87030 157410 199921 84170 208201 102581 99281 111210 138230 161830 83210 85460 140641 90481 76910 84580 76492 79329 276291 86480 105712 75810 157911 91090 76479 79671 83100 118990 154440 199832 80791 92581 113120 97738 81180 242262 86850 151251 143310 109730 108150 100100 95170 117040 163691 83140 86440 108609 76070 82589 98131 106370 113821 84309 78039 172899 194160 126420 118791 86811 82041 168549 191921 95541 77570 84101 78030 119319 82150 144920 169400 86529 243001 76731 81321 113209 133410 81649 116509 112170 80811 105601 140991 198210 94291 129930 102620 132790 115170 98352 78400 89419 109350 407350 154490 76410 126469 141711 136110 99790 96001 82590 91101 96601 138630 185640 100659 116131 198462 93710 86530 119349 158571 84070 79440 97000 106871 84019 105151 94079 83260 89302 83180 124871 108359 84510 134150 141210 150841 153781 172321 91450 101611 126310 89740 101612 136670 104029 118072 83471 82461 82790 79911 99331 89200 128011 123001 123829 83971 121030 80161 85040 91650 80810 76970 89140 106609 99001 3280349 96140 187791 86969 99800 136931 89611 77440 168069 98500 99319 82560 117700 127871 87740 202751]
# PauseEnd = [1621847354720257668 1621847358083256543 1621847362137204614 1621847365740271626 1621847368993645396 1621847374371383993 1621847382753524136 1621847394291117039 1621847401708791436 1621847409631088168 1621847415778124694 1621847422278386388 1621847432672822610 1621847437819561744 1621847447844704004 1621847457290163601 1621847464865539610 1621847471645884050 1621847477235075923 1621847480458843628 1621847481943580776 1621847486193431556 1621845642722699605 1621845649438637745 1621845655379063902 1621845662043589928 1621845669488849522 1621845679993885932 1621845689016750920 1621845696070173768 1621845701820183556 1621845706856005656 1621845715029345184 1621845726431108881 1621845736636520033 1621845743648418037 1621845747713733517 1621845753139829729 1621845764118341146 1621845774883846800 1621845780815970268 1621845785415232254 1621845789116712984 1621845795515524392 1621845802814087384 1621845809692931716 1621845820172436168 1621845826073813940 1621845829433023707 1621845832966295093 1621845835522974714 1621845839359743039 1621845845737677612 1621845852125608654 1621845863292642065 1621845869923629613 1621845876454631419 1621845883003622714 1621845892581953738 1621845902918323145 1621845912727223755 1621845921486460906 1621845928545560852 1621845934610825495 1621845940699564972 1621845947604228449 1621845954452388527 1621845964331266241 1621845974400723528 1621845979813303394 1621845984878154043 1621845993657288865 1621846000310432963 1621846011851179387 1621846020643800001 1621846027245233612 1621846035348574621 1621846041409907304 1621846047017161754 1621846050908431479 1621846055138864170 1621846058885970426 1621846066883364883 1621846076078690460 1621846082349096333 1621846088973257317 1621846095609565891 1621846100619321938 1621846106292553204 1621846112282998291 1621846118011016187 1621846123941598700 1621846131084731463 1621846139935646937 1621846147871861164 1621846154073748579 1621846161046291077 1621846168125363705 1621846177285339708 1621846186089325995 1621846201094351283 1621846207317097516 1621846213294464944 1621846218577628871 1621846225544342525 1621846242686440276 1621846248890110642 1621846253188560673 1621846257038915239 1621846262209551585 1621846267617067207 1621846273142522486 1621846285066402184 1621846294708471999 1621846300332962661 1621846310021301946 1621846318267976313 1621846325686671652 1621846332336272885 1621846337768966527 1621846343805412074 1621846350030628427 1621846367111166769 1621846373333253816 1621846377229282228 1621846381375640120 1621846385877727507 1621846394243498025 1621846404821243026 1621846413572373964 1621846418961209140 1621846424474481620 1621846428852778255 1621846433068423785 1621846438382824188 1621846443934910521 1621846450848206193 1621846459189372323 1621846468912729551 1621846479720347950 1621846483712206830 1621846489833287539 1621846495531794528 1621846504041845008 1621846513977105697 1621846523484026771 1621846531759978990 1621846538831577460 1621846544423926775 1621846550560644222 1621846560600558479 1621846569287253854 1621846575341907480 1621846584855547704 1621846592833307154 1621846604120956288 1621846611351071392 1621846617733265949 1621846624738659900 1621846630686470659 1621846639788494257 1621846646509616919 1621846655280446714 1621846663947091895 1621846670151023538 1621846675838773714 1621846686247556476 1621846696605314620 1621846705023967382 1621846711819258777 1621846717085975755 1621846721177788416 1621846724816794767 1621846729041263397 1621846734585493724 1621846740594511905 1621846746429152966 1621846755541352174 1621846762048580599 1621846766747693752 1621846772417240493 1621846782153414824 1621846794501447350 1621846804488055762 1621846809851085156 1621846817389014032 1621846824428053027 1621846836055984564 1621846842146115704 1621846847675675449 1621846853514924468 1621846861667440583 1621846873251020666 1621846883470587078 1621846889532378167 1621846897581633189 1621846905702437033 1621846912764212614 1621846922603452230 1621846929067563248 1621846937720588897 1621846943790305347 1621846949687810068 1621846957358633656 1621846963827776417 1621846969509047292 1621846981981679681 1621846994139856480 1621847001404606775 1621847007349016355 1621847013358948623 1621847019775811490 1621847031571318896 1621847037924755170 1621847042032107439 1621847045697785196 1621847050348351538 1621847055101610133 1621847060352039951 1621847066178993092 1621847072732566663 1621847081261437915 1621847086744032159 1621847095156972623 1621847102854812921 1621847116623995162 1621847123907522222 1621847127584478476 1621847134331575039 1621847138430931846 1621847144994632134 1621847160917726838 1621847171289750058 1621847177692374127 1621847182451127567 1621847188400279741 1621847197756794844 1621847208629817019 1621847220644191532 1621847226766824414 1621847232891137181 1621847238463791239 1621847244315526388 1621847254637736538 1621847262566577774 1621847269778921622 1621847276742927495 1621847285171612852 1621847296996646603 1621847305166199254 1621847312059562190 1621847317522390398 1621847323477901540 1621847335571547424 1621847344852546061 1621847351095241038]
# NumGC = 4630
# NumForcedGC = 0
# GCCPUFraction = 0.0006154420590126662
# DebugGC = false
# MaxRSS = 13599121408
```

## Test results

Before starting to query the validator, the `nymd` process was using 95 MB of resident memory.

After running the `querier` (`cargo run --release`) for 5min (5200 loop iterations) the used memory increased to 1300 MB.

After 10 min (10500 loop iterations), it was at 2400 MB

For the next 20min the contract was not queried at all, but the memory was never returned to the OS.
